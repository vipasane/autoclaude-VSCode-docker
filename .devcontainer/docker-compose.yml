version: '3.8'

services:
  auto-claude:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auto-claude-dev
    
    # Keep container running for VS Code to attach
    command: sleep infinity
    
    # Security: run as non-root
    user: vscode
    
    # Environment variables
    environment:
      - GRAPHITI_ENABLED=true
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - NODE_ENV=development
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    # Volumes for persistence
    volumes:
      # Workspace mount
      - ..:/workspace:cached
      # Node modules in volumes for Windows performance
      - node-modules-root:/workspace/auto-claude/node_modules
      - node-modules-frontend:/workspace/auto-claude/apps/frontend/node_modules
      - node-modules-backend:/workspace/auto-claude/apps/backend/node_modules
      # Claude CLI config persistence
      - claude-config:/home/vscode/.claude
      - claude-history:/home/vscode/.claude-code
    
    # Ports
    ports:
      - "3000:3000"
      - "8000:8000"
      - "5173:5173"
    
    # Network
    networks:
      - auto-claude-network
    
    # Wait for FalkorDB
    depends_on:
      falkordb:
        condition: service_healthy

  # FalkorDB for Memory Layer
  falkordb:
    image: falkordb/falkordb:latest
    container_name: auto-claude-falkordb
    ports:
      - "6379:6379"
    volumes:
      - falkordb-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - auto-claude-network

volumes:
  node-modules-root:
    name: autoclaude-node-modules-root
  node-modules-frontend:
    name: autoclaude-node-modules-frontend
  node-modules-backend:
    name: autoclaude-node-modules-backend
  claude-config:
    name: autoclaude-claude-config
  claude-history:
    name: autoclaude-claude-history
  falkordb-data:
    name: autoclaude-falkordb-data

networks:
  auto-claude-network:
    name: auto-claude-network
    driver: bridge
