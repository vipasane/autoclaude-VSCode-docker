version: '3.8'

services:
  auto-claude:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auto-claude-dev
    
    # Keep container running for VS Code to attach
    command: sleep infinity
    
    # Security: run as non-root
    user: vscode
    
    # Environment variables
    environment:
      - GRAPHITI_ENABLED=true
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - NODE_ENV=development
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    # Volumes for persistence and performance
    volumes:
      # Workspace mount - main project files
      - ..:/workspace:cached
      # Persist node_modules in volumes for Windows performance
      # These prevent slow file I/O on Windows
      - node-modules-root:/workspace/node_modules
      - node-modules-frontend:/workspace/apps/frontend/node_modules
      # Claude CLI config persistence
      - claude-config:/home/vscode/.claude
      # Claude Code history
      - claude-history:/home/vscode/.claude-code
      # NOTE: We do NOT mount .venv as a volume - let it be created inside workspace
      # This avoids the "empty directory" problem
    
    # Ports
    ports:
      - "3000:3000"   # Frontend dev server
      - "8000:8000"   # Backend API
      - "5173:5173"   # Vite HMR (if used)
    
    # Network
    networks:
      - auto-claude-network
    
    # Dependencies
    depends_on:
      falkordb:
        condition: service_healthy

  # FalkorDB for Memory Layer
  falkordb:
    image: falkordb/falkordb:latest
    container_name: auto-claude-falkordb
    ports:
      - "6379:6379"
    volumes:
      - falkordb-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - auto-claude-network

# Named volumes for data persistence
volumes:
  node-modules-root:
    name: auto-claude-node-modules-root
  node-modules-frontend:
    name: auto-claude-node-modules-frontend
  claude-config:
    name: auto-claude-config
  claude-history:
    name: auto-claude-history
  falkordb-data:
    name: auto-claude-falkordb-data

# Isolated network
networks:
  auto-claude-network:
    name: auto-claude-network
    driver: bridge
